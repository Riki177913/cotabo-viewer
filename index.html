<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>COTABO Disciplinare (Viewer)</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="supabase-config.js" defer></script>
</head>
<body>
  <!-- === SCHERMATA DI LOGIN === -->
  <div id="login-screen" style="text-align: center; padding: 3rem; background: #f0f2f5; min-height: 100vh;">
    <img src="assets/logo-cotabo.png" alt="Logo COTABO" style="max-width: 200px; margin-bottom: 1rem;" />
    <h1>COTABO Disciplinare</h1>
    <p style="color: #555; margin-bottom: 2rem;">Accesso riservato - sola lettura</p>
    <div style="max-width: 400px; margin: 0 auto; background: white; padding: 1.5rem; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
      <h2>Accesso Autorizzato</h2>
      <p>Inserisci la password per accedere ai dati.</p>
      <input 
        type="password" 
        id="password-input" 
        placeholder="Password" 
        style="padding: 0.7rem; font-size: 1rem; width: 100%; margin: 0.5rem 0; border: 1px solid #ccc; border-radius: 6px;"
      />
      <button 
        id="btn-login" 
        style="padding: 0.7rem 1.5rem; background: #0D6EFD; color: white; border: none; font-size: 1rem; border-radius: 6px; cursor: pointer;">
        Accedi
      </button>
      <p id="login-error" style="color: red; display: none; margin: 0.5rem 0;">Password errata</p>
    </div>
  </div>

  <!-- === CONTENUTO PRINCIPALE (dopo login) === -->
  <main id="app" style="display:none;">
    <header>
      <img src="./assets/logo-cotabo.png" alt="Logo COTABO" class="logo" onerror="this.style.display='none';" />
      <h1>COTABO Disciplinare</h1>
      <p>Modalità SOLO LETTURA</p>
    </header>

    <nav>
      <button id="btn-home">Riepilogo</button>
      <button id="btn-archivio">Archivio</button>
    </nav>

    <main id="app-content">
      <!-- === RIEPILOGO === -->
      <section id="home" class="active">
        <h2>Riepilogo Generale</h2>
        <div class="stats-grid">
          <div class="stat-card">
            <h3>Totale Procedimenti</h3>
            <p class="large"><span id="totale">0</span></p>
          </div>
          <div class="stat-card">
            <h3>Ultimo Anno</h3>
            <p class="large"><span id="ultimo-anno">0</span></p>
          </div>
          <div class="stat-card warning">
            <h3>In Corso</h3>
            <p class="large"><span id="in-corso">0</span></p>
          </div>
          <div class="stat-card">
            <h3>Chiusi</h3>
            <p class="large"><span id="chiusi">0</span></p>
          </div>
          <div class="stat-card">
            <h3>Archiviati (24 mesi)</h3>
            <p class="large"><span id="archiviati">0</span></p>
          </div>
        </div>
      </section>

      <!-- === ARCHIVIO === -->
      <section id="archivio" style="display:none;">
        <h2>Archivio Procedimenti</h2>
        <div class="search-box">
          <input type="text" id="cerca-socio" placeholder="Cerca per nome, cognome o sigla..." />
        </div>
        <div id="lista-completa"></div>
      </section>
    </main>
  </main>

  <script>
    // 🔐 Password per l'accesso (modificala quando vuoi)
    const PASSWORD = "cotabo2025"; // ← Cambiala qui per aggiornare la password

    // === Gestione login ===
    document.getElementById('btn-login').addEventListener('click', () => {
      const pwd = document.getElementById('password-input').value;
      if (pwd === PASSWORD) {
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('app').style.display = 'block';
        caricaDaSupabase();
      } else {
        document.getElementById('login-error').style.display = 'block';
      }
    });

    let procedimenti = [];

    // === Carica dati da Supabase ===
    async function caricaDaSupabase() {
      const { data, error } = await supabaseClient
        .from('procedimenti_disciplinari')
        .select('*')
        .order('created_at', { ascending: false });

      if (error) {
        console.error("Errore:", error);
        alert("Errore di rete. Verifica la connessione.");
      } else {
        procedimenti = data;
        aggiornaRiepilogo();
      }
    }

    // === Aggiorna Riepilogo ===
    function aggiornaRiepilogo() {
      const dueAnniFa = new Date();
      dueAnniFa.setFullYear(dueAnniFa.getFullYear() - 2);
      const unAnnoFa = new Date();
      unAnnoFa.setFullYear(unAnnoFa.getFullYear() - 1);

      document.getElementById('totale').textContent = procedimenti.length;
      document.getElementById('ultimo-anno').textContent = procedimenti.filter(p => new Date(p.data_provvedimento) >= unAnnoFa).length;
      document.getElementById('in-corso').textContent = procedimenti.filter(p => p.stato === 'In corso').length;
      document.getElementById('chiusi').textContent = procedimenti.filter(p => p.stato === 'Chiuso').length;
      document.getElementById('archiviati').textContent = procedimenti.filter(p => p.stato === 'Archiviato' && new Date(p.data_provvedimento) >= dueAnniFa).length;

      if (document.getElementById('archivio').style.display !== 'none') {
        inizializzaArchivio();
      }
    }

    // === Inizializza Archivio ===
    function inizializzaArchivio() {
      const input = document.getElementById('cerca-socio');
      const container = document.getElementById('lista-completa');
      container.innerHTML = '';

      const term = input.value.toLowerCase();
      const listaFiltrata = procedimenti.filter(p =>
        p.nome.toLowerCase().includes(term) ||
        p.cognome.toLowerCase().includes(term) ||
        (p.sigla && p.sigla.toLowerCase().includes(term))
      );

      if (listaFiltrata.length === 0) {
        container.innerHTML = '<p>Nessun procedimento trovato.</p>';
        return;
      }

      const soci = {};
      listaFiltrata.forEach(p => {
        const key = `${p.nome} ${p.cognome}`;
        if (!soci[key]) soci[key] = [];
        soci[key].push(p);
      });

      Object.keys(soci).forEach(nome => {
        const procedimentiSocio = soci[nome];
        const primo = procedimentiSocio[0];

        const inCorso = procedimentiSocio.filter(p => p.stato === 'In corso').length;
        const chiusi = procedimentiSocio.filter(p => p.stato === 'Chiuso').length;
        const archiviati = procedimentiSocio.filter(p => p.stato === 'Archiviato').length;

        const card = document.createElement('div');
        card.className = 'card';

        let dettagliHtml = '';
        procedimentiSocio.forEach(p => {
          dettagliHtml += `
            <div style="margin-bottom: 1rem; padding-bottom: 0.8rem; border-bottom: 1px dashed #ccc;">
              <strong>${p.tipo_provvedimento}</strong> – ${p.tipo_segnalazione}<br>
              Data: ${p.data_provvedimento}<br>
              Importo: ${p.importo || 'Nessuno'}<br>
              Stato: <strong>${p.stato}</strong>
            </div>
          `;
        });

        card.innerHTML = `
          <strong>${primo.nome} ${primo.cognome} (${primo.sigla || ''})</strong> – ${primo.tipologia_socio}<br>
          <small>${primo.tipo_segnalazione}</small><br>
          <strong>Provvedimenti:</strong> In corso: ${inCorso}, Chiusi: ${chiusi}, Archiviati: ${archiviati}<br><br>
          ${dettagliHtml}
          <button class="btn-txt" onclick="esportaTXT('${encodeURIComponent(primo.nome)}', '${encodeURIComponent(primo.cognome)}')">
            <i class="fas fa-download"></i> Scarica Riepilogo (.txt)
          </button>
        `;

        container.appendChild(card);
      });
    }

    // === Esporta TXT ===
    function esportaTXT(nomeEnc, cognomeEnc) {
      const nome = decodeURIComponent(nomeEnc);
      const cognome = decodeURIComponent(cognomeEnc);

      const socioProcedimenti = procedimenti.filter(p => 
        p.nome === nome && p.cognome === cognome
      );

      if (socioProcedimenti.length === 0) {
        alert("Nessun procedimento trovato per questo socio.");
        return;
      }

      const socio = socioProcedimenti[0];

      const inCorso = socioProcedimenti.filter(p => p.stato === 'In corso').length;
      const chiusi = socioProcedimenti.filter(p => p.stato === 'Chiuso').length;
      const archiviati = socioProcedimenti.filter(p => p.stato === 'Archiviato').length;

      let testo = `========================================\n`;
      testo += `      RIEPILOGO DISCIPLINARE COTABO\n`;
      testo += `========================================\n\n`;
      testo += `Socio: ${nome} ${cognome} (${socio.sigla || 'N/D'})\n`;
      testo += `Tipologia: ${socio.tipologia_socio}\n`;
      testo += `Data elaborazione: ${new Date().toLocaleDateString('it-IT')}\n\n`;
      testo += `RIEPILOGO PROVVEDIMENTI:\n`;
      testo += `  In Corso: ${inCorso}\n`;
      testo += `  Chiusi: ${chiusi}\n`;
      testo += `  Archiviati: ${archiviati}\n\n`;
      testo += `DETTAGLIO PROVVEDIMENTI:\n\n`;

      socioProcedimenti.forEach((p, i) => {
        testo += `${i+1}. ${p.tipo_provvedimento.toUpperCase()}\n`;
        testo += `   Data: ${p.data_provvedimento}\n`;
        testo += `   Tipo segnalazione: ${p.tipo_segnalazione}\n`;
        testo += `   Provenienza: ${p.provenienza}`;
        if (p.provenienza === 'Colleghi' && p.nominativi_colleghi) {
          testo += ` (${p.nominativi_colleghi})`;
        }
        testo += `\n`;
        if (p.importo) testo += `   Importo: ${p.importo}€\n`;
        if (p.note_segnalazione) testo += `   Note: ${p.note_segnalazione}\n`;
        testo += `   Stato: ${p.stato}\n\n`;
      });

      testo += `========================================\n`;
      testo += `      COOPERATIVA COTABO - RISERVATO\n`;
      testo += `========================================\n`;

      const blob = new Blob([testo], { type: 'text/plain;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `Riepilogo_Disciplinare_${nome}_${cognome}.txt`;
      a.click();
    }

    // === Navigazione ===
    function mostraSezione(id) {
      document.querySelectorAll('section').forEach(s => s.style.display = 'none');
      document.getElementById(id).style.display = 'block';
      if (id === 'archivio') inizializzaArchivio();
    }

    document.querySelectorAll('nav button').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = btn.id.replace('btn-', '');
        mostraSezione(id);
      });
    });

    // === Ricerca live ===
    document.getElementById('cerca-socio').addEventListener('input', function() {
      if (document.getElementById('archivio').style.display !== 'none') {
        inizializzaArchivio();
      }
    });
  </script>
</body>
</html>
